#pragma once

#include "mcp_server.h"
#include "wifi_pentest_manager.h"

namespace xiaozhi {

/**
 * @brief MCP Tools for WiFi Penetration Testing
 *
 * This class registers 8 user-only MCP tools for WiFi security auditing:
 *
 * 1. self.wifi_pentest.scan_targets - Scan available WiFi networks
 * 2. self.wifi_pentest.deauth_attack - Deauthentication broadcast attack
 * 3. self.wifi_pentest.rogue_ap - Rogue AP for handshake capture
 * 4. self.wifi_pentest.pmkid_capture - PMKID capture from RSN IE
 * 5. self.wifi_pentest.dos_attack - Combined denial of service
 * 6. self.wifi_pentest.stop_attack - Stop current attack
 * 7. self.wifi_pentest.export_capture - Export PCAP or HCCAPX
 * 8. self.wifi_pentest.get_status - Get attack status and statistics
 *
 * **Security Features:**
 * - All tools are user-only (not accessible to AI)
 * - Authorization challenge-response required for attacks
 * - Authorization codes displayed on device LCD
 * - Automatic timeouts and rate limiting
 * - All attacks logged with timestamps
 *
 * **Legal Notice:**
 * These tools are designed exclusively for authorized security auditing.
 * Unauthorized use may be illegal. User is responsible for compliance
 * with local laws and regulations.
 */
class WifiPentestMcpTools {
 public:
  /**
   * @brief Register WiFi pentest tools with MCP server
   *
   * @param server MCP server instance
   * @return ESP_OK on success, error code otherwise
   */
  static esp_err_t RegisterTools(McpServer& server);

 private:
  /**
   * @brief Tool: Scan WiFi networks
   *
   * Scans for available WiFi networks and returns information about
   * potential targets (SSID, BSSID, channel, RSSI, auth mode).
   *
   * Parameters: None
   *
   * Returns:
   * {
   *   "networks": [{
   *     "ssid": "TestNetwork",
   *     "bssid": "AA:BB:CC:DD:EE:FF",
   *     "channel": 6,
   *     "rssi": -45,
   *     "auth_mode": "WPA2_PSK"
   *   }]
   * }
   */
  static ReturnValue HandleScanTargets(const PropertyList& properties);

  /**
   * @brief Tool: Deauthentication attack
   *
   * Sends deauthentication frames to disconnect clients from target AP.
   *
   * Parameters:
   * - target_bssid (string, required): BSSID of target AP
   * - target_ssid (string, optional): SSID for verification
   * - duration_seconds (integer, default=10, range: 5-300)
   * - frame_rate (integer, default=10, range: 1-100)
   * - authorization_code (string, required): Code from device LCD
   *
   * Returns:
   * {
   *   "status": "completed|timeout|error|aborted",
   *   "frames_sent": 4500,
   *   "duration": 10,
   *   "errors": 0,
   *   "message": "Attack completed successfully"
   * }
   */
  static ReturnValue HandleDeauthAttack(const PropertyList& properties);

  /**
   * @brief Tool: Rogue AP attack
   *
   * Creates fake AP to capture WPA/WPA2 handshakes.
   *
   * Parameters:
   * - target_bssid (string, required): BSSID to clone
   * - target_ssid (string, required): SSID to clone
   * - channel (integer, required, range: 1-13)
   * - duration_seconds (integer, default=60, range: 10-600)
   * - authorization_code (string, required): Code from device LCD
   *
   * Returns:
   * {
   *   "status": "completed|timeout|error|aborted",
   *   "handshakes_captured": 2,
   *   "pcap_size_bytes": 45678,
   *   "export_available": true,
   *   "message": "Captured 2 handshakes"
   * }
   */
  static ReturnValue HandleRogueApAttack(const PropertyList& properties);

  /**
   * @brief Tool: PMKID capture
   *
   * Captures PMKID from RSN Information Elements.
   *
   * Parameters:
   * - target_bssid (string, required): BSSID of target AP
   * - target_ssid (string, optional): SSID for verification
   * - channel (integer, required, range: 1-13)
   * - duration_seconds (integer, default=30, range: 10-300)
   * - authorization_code (string, required): Code from device LCD
   *
   * Returns:
   * {
   *   "status": "completed|timeout|error|aborted",
   *   "pmkid_captured": true,
   *   "pmkid": "aabbccdd...",
   *   "hccapx_available": true,
   *   "message": "PMKID captured successfully"
   * }
   */
  static ReturnValue HandlePmkidCapture(const PropertyList& properties);

  /**
   * @brief Tool: DoS attack
   *
   * Combined denial of service attack (deauth + beacon flood).
   *
   * Parameters:
   * - target_bssid (string, required): BSSID of target AP
   * - duration_seconds (integer, default=20, range: 5-300)
   * - authorization_code (string, required): Code from device LCD
   *
   * Returns:
   * {
   *   "status": "completed|timeout|error|aborted",
   *   "frames_sent": 12000,
   *   "duration": 20,
   *   "message": "DoS attack completed"
   * }
   */
  static ReturnValue HandleDosAttack(const PropertyList& properties);

  /**
   * @brief Tool: Stop attack
   *
   * Immediately stops any running attack.
   *
   * Parameters: None
   *
   * Returns:
   * {
   *   "status": "stopped",
   *   "message": "Attack stopped successfully"
   * }
   */
  static ReturnValue HandleStopAttack(const PropertyList& properties);

  /**
   * @brief Tool: Export capture
   *
   * Exports captured packets in PCAP or HCCAPX format.
   *
   * Parameters:
   * - format (string, required): "pcap" or "hccapx"
   * - base64_encode (bool, default=true): Encode output as base64
   *
   * Returns (base64_encode=true):
   * {
   *   "format": "pcap",
   *   "data_base64": "AABBCCDD...",
   *   "size_bytes": 45678,
   *   "message": "PCAP exported successfully"
   * }
   *
   * Returns (base64_encode=false):
   * {
   *   "format": "pcap",
   *   "data": [0xAA, 0xBB, ...],
   *   "size_bytes": 45678,
   *   "message": "PCAP exported successfully"
   * }
   */
  static ReturnValue HandleExportCapture(const PropertyList& properties);

  /**
   * @brief Tool: Get attack status
   *
   * Returns current attack state and real-time statistics.
   *
   * Parameters: None
   *
   * Returns:
   * {
   *   "state": "idle|ready|running|finished|timeout|error|aborted",
   *   "attack_type": "none|deauth|rogue_ap|pmkid|dos",
   *   "target_bssid": "AA:BB:CC:DD:EE:FF",
   *   "target_ssid": "TestNetwork",
   *   "elapsed_seconds": 5,
   *   "frames_sent": 500,
   *   "packets_captured": 123,
   *   "handshakes_captured": 1,
   *   "pmkid_captured": false,
   *   "authorization_required": false,
   *   "authorization_code": "A3F7B2C9"  // Only if code is active
   * }
   */
  static ReturnValue HandleGetStatus(const PropertyList& properties);

  // Helper functions

  /**
   * @brief Parse MAC address from string
   * @param mac_str MAC address string (e.g., "AA:BB:CC:DD:EE:FF")
   * @param[out] mac_bytes Output buffer (6 bytes)
   * @return true if parsed successfully
   */
  static bool ParseMacAddress(const std::string& mac_str, uint8_t* mac_bytes);

  /**
   * @brief Format MAC address to string
   * @param mac_bytes MAC address bytes (6 bytes)
   * @return Formatted string (e.g., "AA:BB:CC:DD:EE:FF")
   */
  static std::string FormatMacAddress(const uint8_t* mac_bytes);

  /**
   * @brief Convert auth mode enum to string
   * @param auth_mode WiFi auth mode
   * @return Auth mode string (e.g., "WPA2_PSK")
   */
  static std::string AuthModeToString(wifi_auth_mode_t auth_mode);

  /**
   * @brief Convert attack state enum to string
   * @param state Attack state
   * @return State string (e.g., "running")
   */
  static std::string StateToString(PentestState state);

  /**
   * @brief Convert attack type enum to string
   * @param type Attack type
   * @return Type string (e.g., "deauth")
   */
  static std::string TypeToString(AttackType type);

  /**
   * @brief Encode data as base64
   * @param data Input data
   * @return Base64-encoded string
   */
  static std::string Base64Encode(const std::vector<uint8_t>& data);
};

}  // namespace xiaozhi
