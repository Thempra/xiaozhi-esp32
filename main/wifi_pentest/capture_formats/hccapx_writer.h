// Copyright 2025 XiaoZhi ESP32 Project
// HCCAPX Writer - Hashcat v4 Format Export

#pragma once

#include <cstdint>
#include <string>
#include <vector>

namespace xiaozhi {

// Forward declarations
struct HandshakeCapture;
struct PmkidCapture;

// HCCAPX format (393 bytes for WPA handshake)
struct __attribute__((packed)) HccapxRecord {
  uint32_t signature;          // 0x58504348 ('HCPX')
  uint32_t version;            // 4
  uint8_t  message_pair;       // Bitmask of captured messages (M1=0x80, M2=0x40, M3=0x20, M4=0x10)
  uint8_t  essid_len;          // ESSID length (0-32)
  uint8_t  essid[32];          // ESSID (SSID)
  uint8_t  keyver;             // WPA key version (1=WPA, 2=WPA2)
  uint8_t  keymic[16];         // Key MIC from MSG2
  uint8_t  mac_ap[6];          // AP MAC (BSSID)
  uint8_t  nonce_ap[32];       // ANonce from AP
  uint8_t  mac_sta[6];         // Client MAC
  uint8_t  nonce_sta[32];      // SNonce from client
  uint16_t eapol_len;          // Length of EAPOL frame
  uint8_t  eapol[256];         // EAPOL frame (truncated to 256)
};

// PMKID format (also supported by Hashcat mode 22000)
struct __attribute__((packed)) PmkidRecord {
  uint32_t signature;          // 0x58504348 ('HCPX')
  uint32_t version;            // 4
  uint8_t  pmkid[16];          // PMKID
  uint8_t  mac_ap[6];          // AP MAC (BSSID)
  uint8_t  mac_sta[6];         // Client MAC
  uint8_t  essid_len;          // ESSID length
  uint8_t  essid[32];          // ESSID
};

// HCCAPX Writer
class HccapxWriter {
 public:
  HccapxWriter();
  
  // Convert handshake to HCCAPX
  bool WriteHandshake(const HandshakeCapture& handshake);
  
  // Convert PMKID to HCCAPX
  bool WritePmkid(const PmkidCapture& pmkid);
  
  // Export to binary
  std::vector<uint8_t> Export() const;
  
  // Export to hex string (for MCP transport)
  std::string ExportHex() const;
  
  // Clear
  void Clear();
  
  // Check if valid data exists
  bool HasData() const { return has_data_; }
  
 private:
  std::vector<uint8_t> buffer_;
  bool has_data_ = false;
};

}  // namespace xiaozhi
