// Copyright 2025 XiaoZhi ESP32 Project
// PCAP Writer Implementation

#include "pcap_writer.h"

#include <cstring>

#include "../wifi_packet_analyzer.h"

namespace xiaozhi {

PcapWriter::PcapWriter() {
  Initialize();
}

void PcapWriter::Initialize() {
  buffer_.clear();
  packet_count_ = 0;
  total_size_ = sizeof(PcapGlobalHeader);
  
  // Write global header
  PcapGlobalHeader global_header;
  
  uint8_t* header_bytes = reinterpret_cast<uint8_t*>(&global_header);
  buffer_.insert(buffer_.end(), header_bytes, header_bytes + sizeof(global_header));
}

void PcapWriter::AddPacket(const uint8_t* data, size_t length, int64_t timestamp_us) {
  if (!data || length == 0) return;
  
  // Create packet header
  PcapPacketHeader pkt_header;
  pkt_header.ts_sec = timestamp_us / 1000000;
  pkt_header.ts_usec = timestamp_us % 1000000;
  pkt_header.incl_len = length;
  pkt_header.orig_len = length;
  
  // Write packet header
  uint8_t* header_bytes = reinterpret_cast<uint8_t*>(&pkt_header);
  buffer_.insert(buffer_.end(), header_bytes, header_bytes + sizeof(pkt_header));
  
  // Write packet data
  buffer_.insert(buffer_.end(), data, data + length);
  
  packet_count_++;
  total_size_ += sizeof(pkt_header) + length;
}

void PcapWriter::AddPacket(const CapturedPacket& packet) {
  AddPacket(packet.data, packet.length, packet.timestamp_us);
}

std::vector<uint8_t> PcapWriter::Export() const {
  return buffer_;
}

void PcapWriter::Clear() {
  Initialize();
}

}  // namespace xiaozhi
