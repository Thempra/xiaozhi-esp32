// Copyright 2025 XiaoZhi ESP32 Project
// PCAP Writer - IEEE 802.11 PCAP Format Export

#pragma once

#include <cstdint>
#include <vector>

namespace xiaozhi {

// Forward declaration
struct CapturedPacket;

// PCAP global header (24 bytes)
struct __attribute__((packed)) PcapGlobalHeader {
  uint32_t magic_number = 0xa1b2c3d4;   // Magic number
  uint16_t version_major = 2;            // Major version
  uint16_t version_minor = 4;            // Minor version
  int32_t  thiszone = 0;                 // GMT to local correction
  uint32_t sigfigs = 0;                  // Accuracy of timestamps
  uint32_t snaplen = 65535;              // Max length of captured packets
  uint32_t network = 105;                // Data link type (IEEE 802.11)
};

// PCAP packet header (16 bytes per packet)
struct __attribute__((packed)) PcapPacketHeader {
  uint32_t ts_sec;       // Timestamp seconds
  uint32_t ts_usec;      // Timestamp microseconds
  uint32_t incl_len;     // Number of octets of packet saved
  uint32_t orig_len;     // Actual length of packet
};

// PCAP Writer
class PcapWriter {
 public:
  PcapWriter();
  
  // Start new PCAP file
  void Initialize();
  
  // Add packet to PCAP
  void AddPacket(const uint8_t* data, size_t length, int64_t timestamp_us);
  void AddPacket(const CapturedPacket& packet);
  
  // Export to binary
  std::vector<uint8_t> Export() const;
  
  // Get statistics
  size_t GetPacketCount() const { return packet_count_; }
  size_t GetTotalSize() const { return total_size_; }
  
  // Clear all packets
  void Clear();
  
 private:
  std::vector<uint8_t> buffer_;
  size_t packet_count_ = 0;
  size_t total_size_ = 0;
};

}  // namespace xiaozhi
