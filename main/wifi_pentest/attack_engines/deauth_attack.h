#pragma once

#include <atomic>
#include <cstdint>

#include "esp_err.h"
#include "wifi_pentest_manager.h"

namespace xiaozhi {

// Forward declarations
class WifiFrameInjector;

/**
 * @brief Deauthentication attack engine
 *
 * Sends deauthentication frames to disconnect clients from a target AP.
 * Uses broadcast deauth to affect all clients on the network.
 *
 * **Attack mechanism:**
 * - Sends deauth frames with source = AP BSSID
 * - Destination = broadcast (FF:FF:FF:FF:FF:FF) to affect all clients
 * - Reason code: Class 3 frame from unassociated station
 * - Rate-limited to prevent excessive network impact
 */
class DeauthAttack {
 public:
  explicit DeauthAttack(WifiFrameInjector* injector);
  ~DeauthAttack() = default;

  /**
   * @brief Execute deauthentication attack
   *
   * @param config Attack configuration
   * @param abort_flag Atomic flag to check for abort request
   * @param[out] stats Statistics updated during attack
   * @return ESP_OK on success, error code on failure
   */
  esp_err_t Execute(const DeauthAttackConfig& config,
                    const std::atomic<bool>* abort_flag,
                    AttackStatistics& stats);

 private:
  WifiFrameInjector* frame_injector_;

  // Broadcast MAC for deauth frames
  static constexpr uint8_t kBroadcastMac[6] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
};

}  // namespace xiaozhi
