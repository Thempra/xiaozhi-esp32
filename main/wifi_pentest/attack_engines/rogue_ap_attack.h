#pragma once

#include <atomic>
#include <cstdint>

#include "esp_err.h"
#include "wifi_pentest_manager.h"

namespace xiaozhi {

// Forward declarations
class WifiFrameInjector;
class WifiPacketAnalyzer;

/**
 * @brief Rogue AP attack engine for handshake capture
 *
 * Creates a fake AP with identical SSID/BSSID to capture WPA/WPA2 handshakes
 * when clients attempt to connect.
 *
 * **Attack mechanism:**
 * - Broadcasts beacon frames with cloned SSID/BSSID
 * - Captures incoming association/authentication attempts
 * - Captures EAPoL 4-way handshake exchanges
 * - Stores handshakes in format compatible with Hashcat/Aircrack-ng
 */
class RogueApAttack {
 public:
  RogueApAttack(WifiFrameInjector* injector, WifiPacketAnalyzer* analyzer);
  ~RogueApAttack() = default;

  /**
   * @brief Execute rogue AP attack
   *
   * @param config Attack configuration
   * @param abort_flag Atomic flag to check for abort request
   * @param[out] stats Statistics updated during attack
   * @return ESP_OK on success, error code on failure
   */
  esp_err_t Execute(const RogueApAttackConfig& config,
                    const std::atomic<bool>* abort_flag,
                    AttackStatistics& stats);

 private:
  WifiFrameInjector* frame_injector_;
  WifiPacketAnalyzer* packet_analyzer_;

  // Beacon interval in Time Units (1 TU = 1024 us)
  static constexpr uint16_t kBeaconInterval = 100;

  // Beacon broadcast interval in milliseconds
  static constexpr uint32_t kBeaconBroadcastIntervalMs = 100;
};

}  // namespace xiaozhi
