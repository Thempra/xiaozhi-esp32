#include "pmkid_capture.h"

#include "esp_log.h"
#include "esp_timer.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "wifi_frame_injector.h"
#include "wifi_packet_analyzer.h"

namespace xiaozhi {

static const char* TAG = "PmkidCapture";

PmkidCapture::PmkidCapture(WifiFrameInjector* injector, WifiPacketAnalyzer* analyzer)
    : frame_injector_(injector), packet_analyzer_(analyzer) {
}

esp_err_t PmkidCapture::Execute(const PmkidCaptureConfig& config,
                                const std::atomic<bool>* abort_flag,
                                AttackStatistics& stats) {
  ESP_LOGI(TAG, "Starting PMKID capture");
  ESP_LOGI(TAG, "Target BSSID: %02X:%02X:%02X:%02X:%02X:%02X, Channel: %d",
           config.target_bssid[0], config.target_bssid[1], config.target_bssid[2],
           config.target_bssid[3], config.target_bssid[4], config.target_bssid[5],
           config.channel);

  // Start packet capture
  packet_analyzer_->EnablePmkidExtraction(true);
  esp_err_t ret = packet_analyzer_->StartCapture(config.channel);
  if (ret != ESP_OK) {
    ESP_LOGE(TAG, "Failed to start packet capture");
    return ret;
  }

  // Initialize statistics
  stats.frames_sent = 0;
  stats.pmkid_captured = false;
  int64_t start_time_us = esp_timer_get_time();

  // Attack loop: send association requests and capture PMKIDs
  while (true) {
    // Check abort flag
    if (abort_flag && abort_flag->load()) {
      ESP_LOGI(TAG, "PMKID capture aborted by user");
      break;
    }

    // Check timeout
    int64_t now_us = esp_timer_get_time();
    int64_t elapsed_us = now_us - start_time_us;
    stats.elapsed_seconds = elapsed_us / 1000000;

    if (stats.elapsed_seconds >= config.duration_seconds) {
      ESP_LOGI(TAG, "PMKID capture completed (timeout)");
      break;
    }

    // Check if PMKID was captured
    auto pmkids = packet_analyzer_->GetPmkids();
    if (!pmkids.empty()) {
      stats.pmkid_captured = true;
      ESP_LOGI(TAG, "PMKID captured successfully!");
      break;
    }

    // TODO: Send association requests to trigger PMKID
    // For now, just passive capture
    stats.frames_sent++;

    // Wait before next attempt
    vTaskDelay(pdMS_TO_TICKS(kAssocRequestIntervalMs));

    // Log progress every 5 seconds
    if (stats.elapsed_seconds % 5 == 0 && stats.elapsed_seconds > 0) {
      static uint32_t last_log_second = 0;
      if (stats.elapsed_seconds != last_log_second) {
        ESP_LOGI(TAG, "Progress: %lu seconds elapsed, PMKID: %s",
                 stats.elapsed_seconds,
                 stats.pmkid_captured ? "captured" : "not yet");
        last_log_second = stats.elapsed_seconds;
      }
    }
  }

  // Stop capture
  packet_analyzer_->StopCapture();

  ESP_LOGI(TAG, "PMKID capture finished: %s",
           stats.pmkid_captured ? "success" : "no PMKID captured");

  return ESP_OK;
}

}  // namespace xiaozhi
