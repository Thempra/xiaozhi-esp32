#pragma once

#include <atomic>
#include <cstdint>

#include "esp_err.h"
#include "wifi_pentest_manager.h"

namespace xiaozhi {

// Forward declarations
class WifiFrameInjector;
class WifiPacketAnalyzer;

/**
 * @brief PMKID capture attack engine
 *
 * Captures PMKID from the first frame of the WPA2 4-way handshake (RSN IE).
 * PMKID = HMAC-SHA1-128(PMK, "PMK Name" | MAC_AP | MAC_STA)
 *
 * **Attack mechanism:**
 * - Sends association requests to trigger PMKID transmission
 * - Captures RSN Information Elements from responses
 * - Extracts PMKID from captured frames
 * - No need for full 4-way handshake (faster than traditional capture)
 *
 * **Advantages over traditional handshake capture:**
 * - No need to wait for client connection
 * - No need to deauthenticate clients
 * - Faster and stealthier
 * - Works even when no clients are connected
 */
class PmkidCapture {
 public:
  PmkidCapture(WifiFrameInjector* injector, WifiPacketAnalyzer* analyzer);
  ~PmkidCapture() = default;

  /**
   * @brief Execute PMKID capture attack
   *
   * @param config Attack configuration
   * @param abort_flag Atomic flag to check for abort request
   * @param[out] stats Statistics updated during attack
   * @return ESP_OK on success, error code on failure
   */
  esp_err_t Execute(const PmkidCaptureConfig& config,
                    const std::atomic<bool>* abort_flag,
                    AttackStatistics& stats);

 private:
  WifiFrameInjector* frame_injector_;
  WifiPacketAnalyzer* packet_analyzer_;

  // Association request retry interval in milliseconds
  static constexpr uint32_t kAssocRequestIntervalMs = 1000;
};

}  // namespace xiaozhi
