#pragma once

#include <atomic>
#include <cstdint>

#include "esp_err.h"
#include "wifi_pentest_manager.h"

namespace xiaozhi {

// Forward declarations
class WifiFrameInjector;

/**
 * @brief Combined Denial of Service attack engine
 *
 * Combines multiple attack techniques to maximize network disruption:
 * - Deauthentication broadcast
 * - Beacon flooding with random SSIDs
 * - Channel hopping to affect multiple channels
 *
 * **Attack mechanism:**
 * - Continuously sends deauth frames to disconnect clients
 * - Floods airspace with fake beacon frames
 * - Creates network congestion and prevents new connections
 * - More aggressive than single deauth attack
 *
 * **Use case:**
 * Comprehensive security testing of network resilience under attack
 */
class DosAttack {
 public:
  explicit DosAttack(WifiFrameInjector* injector);
  ~DosAttack() = default;

  /**
   * @brief Execute combined DoS attack
   *
   * @param config Attack configuration
   * @param abort_flag Atomic flag to check for abort request
   * @param[out] stats Statistics updated during attack
   * @return ESP_OK on success, error code on failure
   */
  esp_err_t Execute(const DosAttackConfig& config,
                    const std::atomic<bool>* abort_flag,
                    AttackStatistics& stats);

 private:
  WifiFrameInjector* frame_injector_;

  /**
   * @brief Generate random SSID for beacon flooding
   * @param[out] ssid_buffer Buffer for SSID (32 bytes)
   * @param[out] ssid_len Length of generated SSID
   */
  void GenerateRandomSsid(char* ssid_buffer, size_t& ssid_len);

  // Broadcast MAC
  static constexpr uint8_t kBroadcastMac[6] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

  // Number of fake beacons per cycle
  static constexpr uint32_t kFakeBeaconCount = 5;
};

}  // namespace xiaozhi
