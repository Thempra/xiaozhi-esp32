// Copyright 2025 XiaoZhi ESP32 Project
// WiFi Penetration Testing Manager - Main Orchestrator
//
// WARNING: This module is designed EXCLUSIVELY for:
// - Authorized security audits on your own networks
// - Penetration testing with explicit written authorization
// - Education in controlled environments
//
// PROHIBITED: Use on networks without owner authorization
// The user is responsible for compliance with local laws.

#pragma once

#include <atomic>
#include <cstdint>
#include <memory>
#include <string>
#include <vector>

#include "esp_err.h"
#include "esp_wifi_types.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

namespace xiaozhi {

// Forward declarations
class WifiFrameInjector;
class WifiPacketAnalyzer;

// Attack state machine
enum class PentestState {
  IDLE,           // No attack running
  READY,          // Authorized and configured
  RUNNING,        // Attack in progress
  FINISHED,       // Completed successfully
  TIMEOUT,        // Exceeded duration limit
  ERROR,          // Failed with error
  ABORTED         // User aborted
};

// Attack types
enum class AttackType {
  NONE,
  DEAUTH,         // Deauthentication broadcast
  ROGUE_AP,       // Fake AP for handshake capture
  PMKID_CAPTURE,  // PMKID extraction
  DOS             // Combined DoS attack
};

// Attack configuration
struct AttackConfig {
  AttackType type = AttackType::NONE;
  uint8_t target_bssid[6] = {0};
  std::string target_ssid;
  uint8_t channel = 0;
  uint32_t duration_seconds = 0;
  uint32_t frame_rate = 10;  // Frames per second
};

// Attack statistics
struct AttackStats {
  uint32_t frames_sent = 0;
  uint32_t packets_captured = 0;
  uint32_t handshakes_captured = 0;
  bool pmkid_found = false;
  std::string pmkid;
  uint32_t elapsed_seconds = 0;
  uint32_t errors = 0;
};

// Network scan result
struct ScanResult {
  std::string ssid;
  uint8_t bssid[6];
  uint8_t channel;
  int8_t rssi;
  wifi_auth_mode_t auth_mode;
};

// Main WiFi Penetration Testing Manager
class WifiPentestManager {
 public:
  static WifiPentestManager& GetInstance();

  // Lifecycle
  esp_err_t Initialize();
  void Shutdown();
  bool IsInitialized() const { return initialized_; }

  // Network scanning (reuses WifiManager)
  std::vector<ScanResult> ScanNetworks();

  // Attack control
  esp_err_t StartAttack(const AttackConfig& config);
  esp_err_t StopAttack();
  esp_err_t AbortAttack();

  // Status queries
  PentestState GetState() const { return state_.load(); }
  AttackType GetAttackType() const { return current_attack_type_; }
  AttackStats GetStats() const;
  std::string GetStateString() const;

  // Capture export
  std::vector<uint8_t> ExportPcap() const;
  std::vector<uint8_t> ExportHccapx() const;
  size_t GetCaptureSize() const;

  // Configuration
  static constexpr uint32_t MIN_DURATION_SEC = 5;
  static constexpr uint32_t MAX_DURATION_SEC = 600;
  static constexpr uint32_t MIN_FRAME_RATE = 1;
  static constexpr uint32_t MAX_FRAME_RATE = 100;

 private:
  WifiPentestManager();
  ~WifiPentestManager();

  // Prevent copying
  WifiPentestManager(const WifiPentestManager&) = delete;
  WifiPentestManager& operator=(const WifiPentestManager&) = delete;

  // Attack execution
  void AttackTask();
  static void AttackTaskTrampoline(void* param);

  // Attack implementations
  void ExecuteDeauthAttack();
  void ExecuteRogueApAttack();
  void ExecutePmkidCapture();
  void ExecuteDosAttack();

  // Helpers
  bool ValidateConfig(const AttackConfig& config);
  void UpdateStats();
  void CleanupAttack();

  // State
  bool initialized_ = false;
  std::atomic<PentestState> state_{PentestState::IDLE};
  AttackType current_attack_type_ = AttackType::NONE;
  AttackConfig current_config_;
  AttackStats current_stats_;

  // Components
  std::unique_ptr<WifiFrameInjector> injector_;
  std::unique_ptr<WifiPacketAnalyzer> analyzer_;

  // Task control
  TaskHandle_t attack_task_handle_ = nullptr;
  std::atomic<bool> abort_requested_{false};
  int64_t attack_start_time_us_ = 0;

  // Thread safety
  mutable SemaphoreHandle_t mutex_ = nullptr;
};

}  // namespace xiaozhi
