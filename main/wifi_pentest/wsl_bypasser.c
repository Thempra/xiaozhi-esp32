// Copyright 2025 XiaoZhi ESP32 Project
// WSL (Wi-Fi Stack Libraries) Bypasser Implementation
//
// This component bypasses ESP32 WiFi stack sanity checks to allow
// injection of raw 802.11 management frames (deauth, beacon, etc.)
//
// Based on: https://github.com/risinek/esp32-wifi-penetration-tool

#include "wsl_bypasser.h"
#include "esp_log.h"

static const char* TAG = "WSL_Bypasser";

/**
 * @brief Override ESP32 WiFi stack sanity check function
 *
 * This function is weak-linked in the ESP-IDF WiFi libraries. By providing
 * our own implementation that always returns 0, we bypass the sanity checks
 * that normally prevent transmission of management frames like deauth.
 *
 * The linker will replace the WiFi stack's version with this one at compile time.
 *
 * Original function signature from ESP-IDF:
 * int ieee80211_raw_frame_sanity_check(int32_t arg, int32_t arg2, int32_t arg3);
 *
 * @param arg Unused (frame buffer pointer in original)
 * @param arg2 Unused (frame length in original)
 * @param arg3 Unused (flags in original)
 * @return Always 0 (ESP_OK equivalent)
 */
int ieee80211_raw_frame_sanity_check(int32_t arg, int32_t arg2, int32_t arg3) {
    // Always return success to bypass WiFi stack restrictions
    // This allows transmission of deauth, disassoc, and other management frames
    return 0;
}

/**
 * @brief Log initialization of WSL bypasser
 *
 * Call this from the main application to confirm the bypasser is active.
 * This is a verification function only - the actual bypass happens at link time.
 */
void wsl_bypasser_init(void) {
    ESP_LOGI(TAG, "WSL Bypasser active - raw frame injection enabled");
    ESP_LOGW(TAG, "WiFi stack sanity checks BYPASSED - use responsibly!");
}
